---
title: B树与B+树
date: 2020-04-14 21:47:37
categories: 
- 算法相关
tags:
- B树
- B+树
mathjax: true
---

## B树与B+树

B树与B+树都是多路搜索树，由于二叉搜索树在结点数量巨大时树的深度会变得非常高于是出现了多路查找树来优化树的深度。

## B树

B树的每个结点含有一个或多个关键词。若只有一个关键词时同二叉搜索树，左子树保存所有比该结点关键词小的结点，右子树保存所有比该结点关键词大的结点；若有m-1个关键词，则有m-1棵子树，分别保存两关键词之间的结点。以树中结点的最大子树数量作为B树的阶。

### 结点

- 若根节点不为唯一结点，则根节点至少有两颗子树
- m阶B树中的每个结点最多有m棵子树既至多含有m-1个关键字
- 除根节点外所有结点至少有$ \frac{m}{2} $棵子树既至少含有$\frac m2-1$ 个关键词
- B树的叶子结点为空值，出现在同一层次中，代表查找失败

### 查询

- 将要查找关键字与当前结点的所有关键字做比较
- 若其等于某个关键字代表查找成功
- 否则判断其所处的范围，查找对应子树
- 若找至叶子节点已经没有找到对应关键词则判断查找失败

### 插入

- 若为空树直接插入

- 按查询的方式找到插入位置
- 如果要插入的结点加入该关键词后其关键词数量并未超出限制，则直接将该关键词插入目标节点
- 若要插入的结点加入该关键词后其关键词数量超出限制，则将当前结点以最中间的关键词为中心分裂为两部分，后将中间关键词插入到父节点中，将分裂的两部分作为父节点的子树，后对父节点进行关键词数量进行判断，若超限则对父节点继续进行分裂操作

### 删除

- 要删除关键词的结点为最底层结点
  - 节点内的关键词数量大于$\frac m2-1$ 可以直接删除
  - 节点内的关键词数量等于$\frac m2-1$，且其左右兄弟结点中存在关键词数量大于$\frac m2-1$ ，则**去兄弟结点中借关键词**
    - 在要删除关键词的结点的兄弟结点中挑选适父节目标关键词的后继关键词
    - 将父节目标关键词下一只要删除关键词的结点中，并以后继关键词代替父节目标关键词
    - 视为删除子结点中后继关键词继续执行删除操作
  - 节点内的关键词数量等于$\frac m2-1$，且其左右兄弟结点中不存在关键词数量大于$\frac m2-1$ ，则进行结点合并
    - 删除目标关键词，在父节点中取出关键词与当前结点剩余关键词合并
    - 将合并后的所有关键词合并至其兄弟节点中
    - 之后视为父节点删除了取出的关键词继续执行删除操作
- 要删除关键词的结点不为最底层结点
  - 在子结点中挑选出要删除的目标关键词的后继关键词
  - 以后继关键词代替当前要删除关键词，之后视为删除后继关键词所在结点中的后继关键词继续执行删除操作

## B+树

B+树的信息在叶子节点，所有非叶子节点只起到索引作用，每个索引代表的是其子树中的最大关键词。

B+树有一个指针指向其最小叶子节点，所有叶子节点形成一个有序链表。

### 结点

- 若根节点不为唯一结点，则根节点至少有两颗子树

- m阶B+树每一结点关键词个数范围为$\frac m2$ 到 m，子树的棵树与关键词个数相同
- B+树子树结点内关键词范围为父结点的上一个关键词到当前关键词。
- B+树中叶子结点包含了所有出现过的关键词

### 查询

B+树查找为逐层向下查找，在当前层找到一个大于目标key值的最小值，查找其子树，知道找到目标元素或查找失败。

由于B+树每次查找都需要找到叶子节点，所以B+树的查找是稳定的。

### 插入

假设一颗B+树为m阶

- 若为空树直接插入，该点即使根节点也是叶子节点
- 按查询的方式找到插入位置
- 若要插入的叶子节点有空闲空间（不足m）直接插入结点
- 若要插入的叶子节点空间不足，则将其分为包含前$\frac m2$个关键词的结点与包含其他部分的结点
  - 将包含前$\frac m2$个关键词的结点进位至其父节点中
  - 对父节点执行平衡非叶子结点
- 平衡非叶子结点
  - 若当前结点关键词数量小于m则无需操作
  - 若当前结点关键词数量大于m则且当前结点不为根节点
    - 将当前结点分为包含前$\frac m2$个关键词的结点与包含其他部分的结点
      - 将包含前$\frac m2$个关键词的结点进位至其父节点中
      - 对父节点执行平衡非叶子结点
  - 若当前结点关键词数量大于m则且当前结点为根节点
    - 将当前结点分为包含前$\frac m2$个关键词的结点与包含其他部分的结点
    - 将两个结点进位为一个根节点

### 删除

- 要删除关键词的结点中关键词个数大于$\frac m2$
  - 删除关键词为最大关键词修改父节点中的关键词
  - 否则直接删除
- 要删除关键词的结点中关键词个数小于或等于$\frac m2$
  - 若其兄弟结点中存在关键词数大于$\frac m2$**去兄弟结点中借关键词**
    - 删除当前关键词
    - 将兄弟结点关键词放入当前节点中
    - 之后视为对兄弟结点借的关键词的删除操作
  - 若兄弟结点中没有多余关键词
    - 删除该关键词
    - 将当前结点与兄弟结点行合并操作并在父节点中删除对应索引，对父节点执行删除平衡操作
- 非叶子结点删除平衡操作
  - 若要平衡的结点关键词数量大于$\frac m2$无需平衡，删除结束
  - 若平衡的结点关键词数量小于$\frac m2$
    - 兄弟结点中有盈余结点，则将盈余结点借至当前欲平衡结点
    - 若兄弟结点中无平衡结点执行合并操作后对父节点执行删除平衡操作

### 为何数据库索引更倾向于使用B+树

B+树非叶子结点不存储数据，使得非叶子节点可以存储更多的索引，可以进一步降低树高，降低io次数。

